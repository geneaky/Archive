# 특징
- [[Lucene]]기반 오픈소스 검색엔진으로 JSON 기반의 문서를 저장하고 검색할 수 있으며 분석 작업이 가능하다.
- 준실시간 검색 시스템이다.(실시간이라고 생각될 만큼 색인된 데이터에가 빠르게 검색됨)
- 고가용성을 위한 클러스터 구성이 가능하다
	- 한 대 이상의 노드로 클러스터를 구성하여 높은 수준의 안전성을 달성하고 부하 분산이 가능
- 동적 스키마 생성
	- 입력될 데이터에 대해 미리 스키마 정의 없이 동적으로 생성이 가능
- Rest API 기반 인터페이스 제공하여 사용을 위한 진입장벽이 낮음

# 클러스터, 노드
## 클러스터 
ElasticSearch 클러스터는 여러대의 노드들이 각자의 역할을 바탕으로 연결되어 하나의 시스템처럼 동작하게 되어 있다.

클러스터 성능이 부족할시 노드를 늘려서 대응이 가능하지만 노드를 늘린다고해서 항상 성능이 늘어나는 것은 아니다.
> __이유__ : 
## 노드 
### 마스터 노드
클러스터 상태 관리 및 메타데이터 관리
현재 클러스터에서 마스터 노드의 역할을 하고 있는 단 1개의 노드
### 마스터 후보 노드
마스터 노드에 문제가 생길시 대체될 노드
### 데이터 노드
문서 색인 및 검색 요청 처리
### 코디네이팅 노드
검색 요청 처리
### 인제스트 노드
색인되는 문서의 데이터 전처리(문서가 ES에 저장되기전에 특정 처리하는 행위)

### 노드간 요청 흐름
사용자가 마스터 노드에게 요청을 보낸다 -> 마스터 노드는 본인이 문서를 보유하고 있지 않기 때문에 데이터 노드에게 요청을 전달하여 처리를 요청함

클러스터로 동작하기 때문에 마스터 노드가 아니라 데이터 노드에게 요청을 보내도 동일한 결과를 받을 수 있다.

비슷한 개념으로 코디네이팅 노드에 검색 요청을 전달해도 내부적으로 데이터 노드를 호출하여 결과를 반환 받을 수 있다.

==하지만== 각 노드에게 직접적인 요청을 보내는 방식보다 api gateway를 지나처 로드밸런서를 통해 접근하는 방식으로 구성하는 것이 좋다.

# 인덱스, 샤드
| ElasticSearch | RDBMS    |
| ------------- | -------- |
| index         | database |
| mapping       | schema   |
| document      | row         |


==__index__==

문서가 저장되는 논리적인 공간
문서를 저장하기 위해 반드시 인덱스가 존재해야한다.

인덱스 설계가 가장 첫 번째로 고려해야하는 부분이다.
인덱스 설계에 따라 문서의 구조와 검색 쿼리가 달라진다.

#### 인덱스 설계 
| 케이스                    | 장점                                                       | 단점                                                        |
| ------------------------- | ---------------------------------------------------------- | ----------------------------------------------------------- |
| 하나의 인덱스를 사용할 때 | 관리해야 할 인덱스의 수가 적어 관리 리소스가 적게 발생한다 | 쿼리와 문서의 구조가 복잡해 질 수 있다.                     |
| 여러개의 인덱스로 나눌 때 | 각각의 경우에 최적화된 쿼리와 문서 구조를 사용 할 수 있다  | 관리해야 할 인덱스의 수가 많아 관리 리소스가 발생할 수 있다 |
|                           |                                                            |                                                             |


하나의 인덱스로 단순하게 시작해서 -> 사용 패턴에 따라 인덱스를 별도로 운영하는 방식으로 확장해 나아가는 것이 좋다.

==__shard__==

인덱스에 색인되는 문서가 저장되는 `공간`
> 하나의 인덱스는 반드시 하나 이상의 샤드를 가진다.

#### 샤드 종류
| 종류            | 역할                                                            |
| --------------- | --------------------------------------------------------------- |
| 프라이머리 샤드 | 문서가 저장되는 원본 샤드, 색인과 검색 성능에 모두 영향을 준다. |
| 레플리카 샤드   | 프라이머리 샤드의 복제 샤드, 검색 성능에 영향을 준다. 프라이머리 샤드에 문제가 생기면 레플리카 샤드가 프라이머리 샤드로 승격된다.                                                                |


문서가 -> 프라이머리 샤드 -> 레플리카 샤드로 저장되는 과정을 색인이라고 말할 수 있다.
프라이머리 샤드에서 문서를 분석하는 작업이 있어 자원 소모가 더 크다.

샤드는 인덱스 생성시 설정하게 되는데 프라이머리 샤드와 레플리카 샤드의 수를 설정할 수 있다.

#### 샤드 라우팅
문서가 샤드에 저장되는 방법, 순서를 의미

문서들은 샤드에 고르게 저장이 되는데 샤드의 개수에 변화가 생기면 문서가 저장되는 규칙이 바뀌게 된다. >> 그래서 인덱스의 프라이머리 샤드는 생성 후 변경 불가능 하다 

> Routing Rule = (문서의 ID) % (샤드의 개수)

최소 샤드 수 설정이 중요하다

#### 인덱스 템플릿
매번 인덱스에 할당할 샤드를 미리 만들고 문서를 넣는 작업은 불편하기 때문에 인덱스 템플릿을 만들고 템플릿 내에 인덱스 패턴으로서 등록을 해두는 방식을 사용한다.

``` json
{
	"index_patterns" : ["spring-logs-1"],
	"template" : {
		"setting" : {
			"number_of_shards" : 3,
			"number_of_replicas" : 2
		}
	}
}
```

# 매핑
매핑이란 문서의 구조를 나타내는 정보
